// BRITE POOL Database Schema
// PostgreSQL database configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core User & Authentication Models

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          UserRole  @default(STEWARD)

  // Covenant & Membership
  covenantAcceptedAt  DateTime?
  covenantVersion     String?
  covenantIpAddress   String?

  // Subscription
  subscriptionTier    SubscriptionTier @default(FREE)
  subscriptionStatus  SubscriptionStatus @default(INACTIVE)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  profile       UserProfile?
  sessions      Session[]
  committees    CommitteeMember[]
  tasks         Task[]
  participationLogs ParticipationLog[]
  forumPosts    ForumPost[]
  eventRegistrations EventRegistration[]
  mediaUploads  MediaItem[] @relation("MediaUploads")
  mapLocations  MapLocation[] @relation("MapLocationsCreated")
  coursesCreated Course[] @relation("CoursesCreated")
  courseProgress CourseProgress[] @relation("CourseProgress")

  @@index([email])
  @@index([role])
}

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio             String?
  phone           String?
  location        String?
  timezone        String   @default("UTC")
  language        String   @default("en")

  // Sacred Ledger
  totalEquityUnits Float   @default(0)
  totalHoursLogged Float   @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// Enums

enum UserRole {
  WEB_STEWARD
  BOARD_CHAIR
  COMMITTEE_LEADER
  CONTENT_MODERATOR
  SUPPORT_STAFF
  STEWARD
  PARTNER
  RESIDENT
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  PLATINUM
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELLED
}

// Covenant/Contract Models

model ContractVersion {
  id          String   @id @default(cuid())
  version     String   @unique
  content     String   // Full markdown/HTML content
  publishedAt DateTime @default(now())
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([isActive])
}

// Committee Models

model Committee {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  type        CommitteeType

  members     CommitteeMember[]
  tasks       Task[]
  events      Event[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CommitteeMember {
  id          String   @id @default(cuid())
  userId      String
  committeeId String
  role        CommitteeMemberRole @default(MEMBER)

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)

  joinedAt    DateTime @default(now())

  @@unique([userId, committeeId])
  @@index([committeeId])
  @@index([userId])
}

enum CommitteeType {
  GOVERNANCE
  WEALTH
  EDUCATION
  HEALTH
  OPERATIONS
}

enum CommitteeMemberRole {
  LEADER
  MEMBER
}

// Participation & Sacred Ledger

model ParticipationLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  hours       Float
  description String
  category    String
  status      ParticipationStatus @default(PENDING)

  approvedBy  String?
  approvedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ParticipationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tasks

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    TaskPriority @default(MEDIUM)

  assignedToId String?
  assignedTo   User?     @relation(fields: [assignedToId], references: [id])

  committeeId  String?
  committee    Committee? @relation(fields: [committeeId], references: [id])

  dueDate      DateTime?
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([assignedToId])
  @@index([status])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Events

model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        EventType

  startTime   DateTime
  endTime     DateTime
  location    String?
  virtualLink String?

  capacity    Int?

  committeeId String?
  committee   Committee? @relation(fields: [committeeId], references: [id])

  registrations EventRegistration[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([startTime])
  @@index([type])
}

model EventRegistration {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  status    RegistrationStatus @default(REGISTERED)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  registeredAt DateTime @default(now())

  @@unique([userId, eventId])
  @@index([eventId])
}

enum EventType {
  COMMITTEE_MEETING
  WORKSHOP
  SANCTUARY_EVENT
  VIRTUAL_WEBINAR
}

enum RegistrationStatus {
  REGISTERED
  WAITLISTED
  CANCELLED
  ATTENDED
}

// Communications

model ForumPost {
  id          String   @id @default(cuid())
  title       String?
  content     String
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  parentId    String?
  parent      ForumPost? @relation("Replies", fields: [parentId], references: [id])
  replies     ForumPost[] @relation("Replies")

  categoryId  String?
  category    ForumCategory? @relation(fields: [categoryId], references: [id])

  isPinned    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
  @@index([categoryId])
  @@index([createdAt])
}

model ForumCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?

  posts       ForumPost[]

  createdAt   DateTime @default(now())
}

// Announcements

model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String
  priority    AnnouncementPriority @default(INFO)

  targetRoles UserRole[]

  isPinned    Boolean  @default(false)
  publishedAt DateTime @default(now())
  expiresAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([publishedAt])
  @@index([isPinned])
}

enum AnnouncementPriority {
  URGENT
  IMPORTANT
  INFO
}

// Media Gallery System

model MediaItem {
  id           String   @id @default(cuid())
  url          String
  thumbnailUrl String
  mediumUrl    String?
  filename     String
  filesize     Int
  mimeType     String
  type         MediaType
  category     MediaCategory
  tags         String[]
  uploadedById String
  uploadedBy   User     @relation("MediaUploads", fields: [uploadedById], references: [id])
  albumItems   AlbumItem[]
  mapLocationId String?
  mapLocation  MapLocation? @relation(fields: [mapLocationId], references: [id])
  createdAt    DateTime @default(now())

  @@index([uploadedById])
  @@index([type])
  @@index([category])
  @@index([mapLocationId])
}

model Album {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String   @unique
  items       AlbumItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AlbumItem {
  id          String   @id @default(cuid())
  albumId     String
  mediaItemId String
  order       Int      @default(0)

  album       Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  mediaItem   MediaItem @relation(fields: [mediaItemId], references: [id], onDelete: Cascade)

  addedAt     DateTime @default(now())

  @@unique([albumId, mediaItemId])
  @@index([albumId])
}

enum MediaType {
  PHOTO
  VIDEO
  DRONE_FOOTAGE
  TIMELAPSE
}

enum MediaCategory {
  PROJECT_PROGRESS
  EVENTS
  SANCTUARY_NATURE
  CONSTRUCTION
  COMMUNITY
  AERIAL
}

// Interactive Maps

model MapLocation {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  latitude    Float
  longitude   Float
  type        LocationType
  status      LocationStatus @default(PLANNED)
  photos      MediaItem[]
  createdById String
  createdBy   User @relation("MapLocationsCreated", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([status])
}

enum LocationType {
  FACILITY
  DEVELOPMENT_ZONE
  POINT_OF_INTEREST
  NATURAL_FEATURE
  INFRASTRUCTURE
}

enum LocationStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  OPERATIONAL
}

// Learning Management System

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  slug        String   @unique
  thumbnail   String?

  createdById String
  createdBy   User     @relation("CoursesCreated", fields: [createdById], references: [id])

  status      CourseStatus @default(DRAFT)
  isPublished Boolean  @default(false)

  lessons     Lesson[]
  progress    CourseProgress[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([isPublished])
}

model Lesson {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int      @default(0)
  type        LessonType

  videoUrl    String?
  pdfUrl      String?
  content     String?  // Markdown content

  duration    Int?     // Duration in minutes

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([order])
}

model CourseProgress {
  id           String   @id @default(cuid())
  userId       String
  courseId     String

  user         User     @relation("CourseProgress", fields: [userId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  completedLessons String[] // Array of lesson IDs
  progress     Float    @default(0) // 0-100 percentage
  isCompleted  Boolean  @default(false)

  startedAt    DateTime @default(now())
  completedAt  DateTime?

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

enum CourseStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  VIDEO
  PDF
  TEXT
  QUIZ
}

// Affiliate Partners

model Partner {
  id          String   @id @default(cuid())
  name        String
  description String?
  logo        String?
  website     String?
  email       String?
  category    PartnerCategory
  status      PartnerStatus @default(PENDING)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([status])
}

enum PartnerCategory {
  ADVISORY_BOARD
  PRACTITIONER
  SPONSOR
  VENDOR
  COLLABORATOR
}

enum PartnerStatus {
  PENDING
  ACTIVE
  INACTIVE
}
